---
title: "rbashでのコマンド制限は思ったとおりに動かないかもしれない"
emoji: "📝"
type: "tech"
topics: ["ssh", "セキュリティ", "rbash"]
published: true
---

## 概要
sshでログインする、あるユーザに対して、rbashを利用しcdやechoなどのコマンドを一部しか使えなくしたかったのですが、rbashは予想通りに機能せず、下記のやり方でssh接続時にrbashで制限したいコマンドも実行できることが分かりました。
```
$ ssh foo@bar [制限したいコマンド]
```

## 環境
下記の通り$HOME/bin以下のcat, date, echo, lsしか実行できないように設定したつもりでした。
なお、rbashの設定方法は検索してもらえれば日本語の記事が複数見つかります。

- OS: Ubuntu 20.04.3 LTS
```
foo@bar:~$ uname -a
Linux ubuntu 5.4.0-1055-raspi #62-Ubuntu SMP PREEMPT Wed Mar 2 14:43:34 UTC 2022 aarch64 aarch64 aarch64 GNU/Linux
```
- シェル: rbash
```
foo@bar:~$ echo $SHELL
/bin/rbash
```

- rbash環境
```
foo@bar:~$ cat .bash_profile
PATH="$HOME/bin"
```
```
foo@bar:~$ ls -al bin/
total 8
drwxrwxr-x 2 foo foo 4096 Mar 13 13:27 .
drwxr-xr-x 6 foo foo 4096 Mar 13 13:25 ..
lrwxrwxrwx 1 foo foo    8 Mar 13 13:17 cat -> /bin/cat
lrwxrwxrwx 1 foo foo    9 Mar 13 13:27 date -> /bin/date
lrwxrwxrwx 1 foo foo    9 Mar 13 11:53 echo -> /bin/echo
lrwxrwxrwx 1 foo foo    7 Mar 13 13:05 ls -> /bin/ls
```

## 検証内容
sshログイン後はtouchコマンドが使えません。
```
foo@bar:~$ touch tmp.txt
-rbash: /usr/lib/command-not-found: restricted: cannot specify `/' in command names
```

ssh接続時に以下の通りtouchコマンドのシンボリックリンクを$PATHに配置できます。
lnはrbashでは使えないようにしています。
```
ssh foo@bar ln -s /bin/touch /home/foo/bin/
```

下記の通り$PATHに配置されています。
```
foo@bar:~$ ls -al bin/
total 8
drwxrwxr-x 2 foo foo 4096 Mar 13 14:04 .
drwxr-xr-x 6 foo foo 4096 Mar 13 13:25 ..
lrwxrwxrwx 1 foo foo    8 Mar 13 13:17 cat -> /bin/cat
lrwxrwxrwx 1 foo foo    9 Mar 13 13:27 date -> /bin/date
lrwxrwxrwx 1 foo foo    9 Mar 13 11:53 echo -> /bin/echo
lrwxrwxrwx 1 foo foo    7 Mar 13 13:05 ls -> /bin/ls
lrwxrwxrwx 1 foo foo   10 Mar 13 14:04 touch -> /bin/touch
```

その後は問題なくtouchが使えます。
```
foo@bar:~$ ls
bin
foo@bar:~$ touch tmp.txt
foo@bar:~$ ls
bin  tmp.txt
```

## 推定原因
下記のコマンド出力結果を見ると、sshログイン後のシェルをrbashに変更しても、接続時のシェルは変更されていません。
これが原因だと思われます。
```
# ログイン後のシェルは設定通りrbash
foo@bar:~$ echo $SHELL
/bin/rbash
```

```
# 接続時のシェルはbashのまま
$ ssh foo@bar echo $SHELL
/bin/bash
```

## 参考情報(sshdのForceCommand設定)
私の場合ログインユーザに使わせたいコマンドは一つのみだったため、sshdのForceCommandという設定で対応できそうです。
これは、「クライアントが指定したコマンドを無視し、ここで指定されたコマンドを強制的に実行する」ことができる設定です。
```ssh foo@bar [制限したいコマンド]```を使った場合でも、ForceCommandのみが実行され、制限したいコマンドは実行できませんでした。

## まとめ
私にとっては ```ssh foo@bar [制限したいコマンド]``` でrbashの制限を回避できることは予想外の挙動でした。
他にもそう思う人はいると思いましたので、備忘録も兼ねて記事にしました。